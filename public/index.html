<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letterboxd Image Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üé¨ Letterboxd Image Generator</h1>

    <form id="image-form">
      <div class="card">
        <label for="letterboxd-url">Letterboxd URL:</label>
        <input type="url" id="letterboxd-url" placeholder="https://letterboxd.com/username/film/..." required />
        <button type="submit">Generate Image</button>
      </div>

      <details id="settings-panel" class="card">
        <summary>‚öôÔ∏è Advanced Settings</summary>

        <h2>üõ†Ô∏è Customize Metadata Order</h2>
        <ul id="reorder-list">
            <li data-id="title"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-title" checked> Title</li>
            <li data-id="year"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-year" checked> Year</li>
            <li data-id="director"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-director" checked> Director</li>
            <li data-id="actors"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-actors" checked> Actors</li>
            <li data-id="genre"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-genre" checked> Genre</li>
            <li data-id="rating"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-rating" checked> Rating</li>
            <li data-id="tags"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-tags" checked> Tags</li>
            <li data-id="music"><span class="drag-handle">‚ò∞</span> <input type="checkbox" id="show-music"> Music</li>
          </ul>
          

        <h2>üé® Visual Settings</h2>
        <label><input type="checkbox" id="blur-backdrop" checked> Blur Backdrop</label>
        <label><input type="checkbox" id="gradient-toggle" checked> Black Gradient Overlay</label>

        <label>Backdrop Brightness: <span id="backdrop-brightness-value">60</span>%</label>
        <input type="range" id="backdrop-brightness" min="0" max="100" value="60">

        <label>Poster Scale: <span id="poster-scale-value">1.0</span>x</label>
        <input type="range" id="poster-scale" min="0.5" max="2.0" step="0.1" value="1.0">

        <label>Footer Scale: <span id="footer-scale-value">1.2</span>x</label>
        <input type="range" id="footer-scale" min="0.5" max="2.0" step="0.1" value="1.0">

        <label>Poster Top Margin: <span id="poster-top-value">240</span>px</label>
        <input type="range" id="poster-top" min="50" max="400" value="240">

        <label>Title Below Poster: <span id="title-below-poster-value">60</span>px</label>
        <input type="range" id="title-below-poster" min="10" max="200" value="60">

        <label>Line Height: <span id="line-height-value">72</span>px</label>
        <input type="range" id="line-height" min="20" max="120" value="72">

        <label>Between Sections: <span id="between-sections-value">60</span>px</label>
        <input type="range" id="between-sections" min="10" max="150" value="60">
      </details>

      <div id="progress" class="progress" style="display:none"></div>
      <div id="result" class="result" style="display:none">
        <img id="generated-image" alt="Generated Image" />
        <div class="buttons">
          <button id="copy-image">Copy Image</button>
          <button id="download-image">Download Image</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Live value display for sliders
      const sliderIds = [
        'poster-top', 'title-below-poster', 'line-height',
        'between-sections', 'backdrop-brightness', 'poster-scale', 'footer-scale'
      ];

      sliderIds.forEach(id => {
        const input = document.getElementById(id);
        const display = document.getElementById(`${id}-value`);
        input.addEventListener('input', () => {
          display.textContent = parseFloat(input.value);
        });
      });

      // SortableJS for drag
      Sortable.create(document.getElementById('reorder-list'), {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        touchStartThreshold: 10
      });

      // Form submit
      document.getElementById('image-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const progress = document.getElementById('progress');
        const result = document.getElementById('result');
        const generatedImage = document.getElementById('generated-image');
        const copyButton = document.getElementById('copy-image');
        const downloadButton = document.getElementById('download-image');

        progress.style.display = 'block';
        progress.textContent = 'Generating...';
        result.style.display = 'none';

        const order = Array.from(document.querySelectorAll('#reorder-list li')).map(li => li.dataset.id);

        const settings = {
          contentOrder: order,
          showTitle: document.getElementById('show-title').checked,
          showYear: document.getElementById('show-year').checked,
          showGenre: document.getElementById('show-genre').checked,
          showDirector: document.getElementById('show-director').checked,
          showMusic: document.getElementById('show-music').checked,
          showActors: document.getElementById('show-actors').checked,
          showRating: document.getElementById('show-rating').checked,
          showTags: document.getElementById('show-tags').checked,
          blurBackdrop: document.getElementById('blur-backdrop').checked,
          gradientOverlay: document.getElementById('gradient-toggle').checked,
          backdropBrightness: parseFloat(document.getElementById('backdrop-brightness').value) / 100,
          posterScale: parseFloat(document.getElementById('poster-scale').value),
          footerScale: parseFloat(document.getElementById('footer-scale').value),
          spacing: {
            posterTop: parseInt(document.getElementById('poster-top').value),
            titleBelowPoster: parseInt(document.getElementById('title-below-poster').value),
            lineHeight: parseInt(document.getElementById('line-height').value),
            betweenSections: parseInt(document.getElementById('between-sections').value),
          }
        };

        try {
          const res = await fetch('/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              letterboxdUrl: document.getElementById('letterboxd-url').value,
              settings
            })
          });

          if (!res.ok) throw new Error('Failed to generate image');

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          generatedImage.src = url;
          result.style.display = 'block';
          progress.style.display = 'none';

          copyButton.onclick = async () => {
            await navigator.clipboard.write([new ClipboardItem({ 'image/jpeg': blob })]);
            alert('Image copied to clipboard!');
          };

          downloadButton.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'letterboxd-poster.jpg';
            a.click();
          };

        } catch (err) {
          progress.textContent = 'Error: ' + err.message;
        }
      });
    });
  </script>
</body>
</html>
